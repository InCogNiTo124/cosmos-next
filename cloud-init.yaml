#cloud-config

mounts:
  - [ "/dev/disk/by-id/scsi-0HC_Volume_{{ volume_id }}", "/data", "ext4", "discard,defaults", "0", "2" ]

write_files:
  - path: /etc/environment
    content: |-
      KUBECONFIG=/etc/rancher/k3s/k3s.yaml

  # Configure Traefik to use the persistent volume for ACME
  - path: /var/lib/rancher/k3s/server/manifests/traefik-config.yaml
    content: |
      apiVersion: helm.cattle.io/v1
      kind: HelmChartConfig
      metadata:
        name: traefik
        namespace: kube-system
      spec:
        valuesContent: |-
          additionalArguments:
            - "--certificatesresolvers.myresolver.acme.email={{ email }}"
            - "--certificatesresolvers.myresolver.acme.storage=/mnt/data/traefik/acme.json"
            - "--certificatesresolvers.myresolver.acme.tlschallenge=true"
            - "--certificatesresolvers.myresolver.acme.caserver={{ ca_server }}"
          volumes:
            - name: data-volume
              mountPath: "/mnt/data"
              hostPath: "/data"

  # Reconfigure Local Path Provisioner to use /data/k3s-storage
  - path: /var/lib/rancher/k3s/server/manifests/local-path-storage.yaml
    content: |
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: local-path-config
        namespace: kube-system
      data:
        config.json: |-
          {
            "nodePathMap": [
              {
                "node": "DEFAULT_PATH_FOR_NON_LISTED_NODES",
                "paths": [
                  "/data/k3s-storage"
                ]
              }
            ]
          }

  # Install ArgoCD via HelmChart
  - path: /var/lib/rancher/k3s/server/manifests/argocd-helm.yaml
    content: |
      apiVersion: helm.cattle.io/v1
      kind: HelmChart
      metadata:
        name: argocd
        namespace: kube-system
      spec:
        repo: https://argoproj.github.io/argo-helm
        chart: argo-cd
        targetNamespace: argocd
        createNamespace: true
        # Wait for the chart to be ready
        valuesContent: |-
          server:
            extraArgs:
              - --insecure # Optional: if you want to handle TLS at Traefik level easily

  # Bootstrap ArgoCD Apps
  - path: /var/lib/rancher/k3s/server/manifests/argocd-apps.yaml
    content: |
{{ argocd_apps }}

runcmd:
  # Ensure the mount point exists (cloud-init mounts usually handle this, but for safety)
  - mkdir -p /data
  
  # Ensure subdirectories exist
  - mkdir -p -m 0755 /data/traefik
  - mkdir -p -m 0755 /data/k3s-storage

  # Install k9s
  - wget https://github.com/derailed/k9s/releases/download/v0.50.16/k9s_Linux_amd64.tar.gz && tar -xzvf k9s_Linux_amd64.tar.gz && mv k9s /usr/local/bin/ && rm k9s_Linux_amd64.tar.gz
  
  # Install k3s
  - curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=v1.34.3+k3s1 sh -

